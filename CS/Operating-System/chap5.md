# 5. 输入/输出（I/O）管理

## I/O管理概述

### I/O设备

#### 设备的分类

按信息交换单位分类：

1. 块设备：速率高、可寻址
2. 字符设备：速率低、不可寻址

按传输速率分类：

1. 低速设备
2. 中速设备
3. 高速设备

#### I/O接口

> I/O 接口（设备控制器）位于 CPU 与设备之间

三部分构成：

1. 设备控制器与 CPU 的接口
2. 设备控制器与设备的接口
3. I/O 逻辑

主要功能：

1. 接收和识别 CPU 发来的命令
2. 数据交换
3. 标识和报告设备的状态
4. 地址识别
5. 数据缓冲
6. 差错控制

#### I/O端口

> 设备控制器中可被 CPU 直接访问的寄存器

- 数据寄存器
- 状态寄存器
- 控制寄存器

为了实现 CPU 与 I/O 端口通信，有两种方法

1. 独立编址
2. 同一编址。又称内存映射I/O

### I/O控制方式

#### 程序直接控制方式

CPU 要不断地测试 I/O 设备的状态，因为 CPU 中未采用中断机构，使 I/O 设备无法向 CPU 报告它已经完成了一个字符的输入操作

CPU 与 I/O 设备只能串行工作，CPU 的利用率相当低

#### 中断驱动方式

允许 I/O 设备主动打断 CPU 的运行并请求服务

但数据中的每个字在存储器与 I/O 控制器之间的传输都必须经过 CPU，导致仍然会消耗较多的 CPU 时间

#### DMA方式

特点：

1. 基本单位是数据块
2. 传输的数据，从设备直接到内存，或相反
3. 仅在传送一个或多个数据块的开始和结束时，才需要 CPU 的干预，整块数据的传送是在 DMA 控制器的控制下完成的

DMA 控制器须设置4类寄存器：

1. 命令/状态寄存器（CR）
2. 内存地址寄存器（MAR）
3. 数据寄存器（DR）
4. 数据计数器（DC）

只有在传送开始和结束时才需要 CPU 的参与

#### 通道控制方式

 I/O 通道是指专门负责输入/输出的处理机

通道指令类型单一，没有自己的内存，通道程序放在主机内存中，通道与 CPU 共享内存

DMA 需要 CPU 控制传输的数据块大小、传输的内存位置，通道中这些信息由通道控制。每个 DMA 控制器对应一台设备与内存传递数据，一个通道可以控制多台设备与内存的数据交换

### I/O软件层次结构

1. 用户层 I/O 软件
2. 设备独立型软件
3. 设备驱动程序
4. 中断处理程序

### 应用程序I/O接口

1. 字符设备接口
2. 块设备接口
3. 网络设备接口
4. 阻塞/非阻塞 I/O

## 设备独立性软件

### 与设备无关的软件

### 高速缓存与缓冲区

#### 磁盘高速缓冲（Disk Cache）

逻辑上属于磁盘，物理上是驻留在内存中的盘块

#### 缓冲区（Buffer）

目的：

1. 缓和 CPU 与 I/O 设备间速度不匹配的矛盾
2. 减少对 CPU 的中断频率，放宽对 CPU 中断响应时间的限制
3. 解决基本数据单元大小（即数据粒度）不匹配的问题
4. 提高 CPU 和 I/O 设备之间的并行性

实现方法：

1. 采用硬件缓冲器
2. 采用缓冲区（位于内存区域）

缓冲技术分类：

假设磁盘把一块数据输入到缓冲区的时间为T，操作系统将缓冲区数据送到用户区时间为 M，CPU 对这块数据处理时间为 C

1. 单缓冲：缓冲区写入或取出时，另一方等待

   处理每块数据用时 max(C, T) + M

2. 双缓冲：

   处理一块数据用时 max(C + M, T)

   若 C + M < T，则可使块设备连续输入；若 C + M > T，则可使 CPU 不必等待设备输入

3. 循环缓冲：包含多个大小相等的缓冲区，每个缓冲区有一个链接指针指向下一个缓冲区，最后一个缓冲区指向第一个缓冲区，多个缓冲区构成一个环形

4. 缓冲池：

   使用状况：空缓冲队列、装满输入数据的缓冲队列（输入队列）和装满输出数据的缓冲队列（输出数据）

   4种缓冲区：收容输入数据、提取输入数据、收容输出数据、提取输出数据

#### 高速缓存与缓冲区对比

![高速缓存和缓冲区对比](https://raw.githubusercontent.com/BluePrintYang/PicHub/master/premaster/image-20230926164433007.png)

### 设备分配与回收

#### 设备分配概述

尽可能让设备忙碌，又要避免不合理分配造成进程死锁

独占设备、共享设备和虚拟设备

1. 独占式使用设备
2. 分时式共享使用设备
3. 以 SPOOLing 方式使用外部设备：将设备同时分配给多个进程。实现了对设备的 I/O 操作的批处理

#### 设备分配的数据结构

- 设备控制表（DCT）：一个设备控制表表征一个设备
- 控制器控制表（COCT）
- 通道控制表（CHCT）
- 系统设备表（SDT）：整个系统只有一张

设备控制器控制设备与内存交换数据，设备控制器需要请求通道为它服务，每个 COCT 有一个表项存放指向相应通道控制表（CHCT）的指针。CHCT 与 COCT 的关系是一对多

#### 设备分配的策略

1. 设备分配原则
2. 设备分配方式
   1. 静态分配：主要用于独占
   2. 动态分配：使用不当，造成死锁
3. 设备分配算法

#### 设备分配的安全性

防止进程发生死锁

1. 安全分配方式：CPU 与 I/O 设备串行
2. 不安全分配方式

#### 逻辑设备名到物理设备名的映射

系统中设置一张逻辑设备表（LUT），将逻辑设备名映射为物理设备名

两种方式：

1. 整个系统一张 LUT
2. 每个用户一张 LUT

### SPOOLing技术（假脱机技术）

将独占设备改造成共享设备的技术

1. 输入井和输出井：磁盘上开辟。模拟脱机输入输出
2. 输入缓冲区和输出缓冲区：内存中开辟。暂存输入输出
3. 输入进程和输出进程：模拟脱机输入输出时的外围控制机

特点：

1. 提高了 I/O 的速度
2. 将独占设备改造为共享设备
3. 实现了虚拟设备的功能

以空间换时间的技术

### 设备驱动程序接口

## 磁盘和固态硬盘

### 磁盘

磁盘 磁道 扇区 盘块

密度从外道向里道增加，存储能力受限于最内道的最大记录密度

扇区是磁盘可寻址的最小单位

柱面号·盘面号·扇区号

### 磁盘的管理

#### 磁盘初始化

低级格式化（物理格式化）：分成扇区，为每个扇区使用特殊的数据结构，填充磁盘

#### 分区

1. 将磁盘分为由一个或多个柱面组成的分区
2. 对物理分区进行逻辑格式化（创建文件系统）

多个相邻的扇区组合在一起，形成一簇，文件所占用的空间只能是簇的整数倍

#### 引导块

自举程序通常存放在 ROM 中，只在 ROM 中保留很小的自举装入程序，完整的引导程序保存在磁盘的启动块上，启动块位于磁盘的固定位置。具有启动分区的磁盘称为**启动磁盘**或**系统磁盘**

#### 坏块

对坏块的的处理实质上就是用某种机制使系统不去使用坏块

### 磁盘调度算法

1. 寻找时间 $T_s$，跨越n条磁道的时间，启动磁臂的时间s，m是与磁盘驱动器有关的常数

   $T_s = m \times n + s$

2. 旋转延迟时间$T_r$，转速 r

   $T_r = \frac{1}{2r}$

3. 传输时间 $T_t$，取决于每次所读/写的字节数b和磁盘的旋转速度。N为一个磁道上的字节数

   $T_t = \frac{b}{rN}$

寻道时间与磁盘调度算法相关；延迟时间和传输时间都与磁盘旋转速度相关，且为线性相关

#### 先来先服务算法（FCFS）

公平

#### 最短寻找时间优先（SSTF）

会产生饥饿现象

#### 扫描（SCAN）算法（电梯调度算法）

局部性不如 FCFS 和 SSTF

#### 循环（C-SCAN）扫描

回返时直接快速移动到起始端而不服务任何请求

LOOK 调度：磁头移动只需到达最远端的一个请求即可返回，不需要到达磁盘端点（默认）

![磁盘调度算法比较](https://raw.githubusercontent.com/BluePrintYang/PicHub/master/premaster/image-20230926172837946.png)

错位命名

### 固态硬盘

#### 固态硬盘的特性

闪存翻译层将来自 CPU 的逻辑块读写请求翻译成对底层物理设备的读写控制信号，相当于扮演了磁盘控制器的角色

数据以页为单位读写

随机写很慢。擦除块比较慢；写操作尝试修改包含已有数据的页P，那么这个块中所有含有用数据的页都必须被复制到一个新块中，然后才能进行对页P的写操作

随机访问速度比机械硬盘快，没有任何机械噪声和振动，能耗更低、抗震性好、安全性高

#### 磨顺均衡（Wear Leveling）

寿命有限，几百次到几千次

1. 动态磨损均衡：写入数据时，自动选择较新的
2. 静态磨损均衡：自动检测并进行数据分配，让老的承担无需写数据的存储任务