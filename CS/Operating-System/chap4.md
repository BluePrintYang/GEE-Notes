# 4. 文件管理

## 文件系统基础

### 文件的基本概念

### 文件控制块和索引结点

#### 文件的属性

操作系统通过文件控制块（FCB）来维护文件元数据

#### 文件控制块

用来存放控制文件需要的各种信息的数据结构

FCB 的有序集合称为**文件目录**

包含：

- 基本信息
- 存取控制信息
- 使用信息

一个文件目录也被视为一个文件，称为目录文件

文件目录通常存放在磁盘上

#### 索引结点

文件描述信息单独形成一个称为索引结点的数据结构，简称 i 结点（inode）

文件目录中每个目录项仅由文件名和指向该文件所对应的 i 结点指针构成

FCB 必须连续存放

:star2:假设一个 FCB 为64B，盘块大小是 1KB，则每个盘块中可以存放 16 个FCB

1. 磁盘索引结点
2. 内存索引结点

### 文件的操作

#### 文件的基本操作

#### 文件的打开与关闭

### 文件保护

#### 访问类型

#### 访问控制

### 文件的逻辑结构

#### 无结构文件（流式文件）

以 字节（Byte）为单位

#### 有结构文件（记录式文件）

##### 顺序文件

##### 索引文件

##### 索引顺序文件

##### 直接文件或散列文件

### 文件的物理结构

#### 连续分配

寻道数和寻道时间最小，支持顺序访问和直接访问

优点：实现简单、存取速度快

缺点：

1. 文件长度不宜动态增加
2. 删除插入会需要物理上移动相邻记录
3. 反复增删会产生外部碎片
4. 很难确定一个文件需要的空间大小

#### 链接分配

##### 隐式链接

目录项含文件第一块指针和最后一块指针

缺点：只适合顺序访问，随机访问效率很低。稳定性也是问题，链表指针丢失导致文件数据丢失

通常解决方法是将几个盘块组成簇（Cluster），代价是增加了内部碎片

##### 显式链接

把用于链接文件各物理块地址的指针，从文件末尾提取出来，显式的存放在内存的一张链表中。

整个磁盘中仅设置一张，称为**文件分配表**（FAT）

FAT 表项与全部磁盘块一一对应

FAT 在系统启动时被读入内存，查找记录过程在内存中进行，提高了速度，减少了访问磁盘次数

#### 索引分配

索引分配将每个文件所有的盘块号集中在一起构成**索引块（表）**

支持直接访问，没有外部碎片

缺点：增加了系统存储空间开销，每个文件都必须有索引块，索引块应尽可能小，但太小无法支持大文件

- 链接方案：多个索引块链接
- 多层索引
- 混合索引

访问文件需要两次访问外存，通常将文件的索引块读入内存，提高访问速度

#### :star2:混合索引分配

全面地照顾小型、中型、大型和特大型文件

1. 直接地址
2. 一次间接地址
3. 多次间接地址

## 目录

### 目录的基本概念

### 目录结构

#### 单级目录结构

整个文件只建立一张目录表，每个文件占一个目录项

实现了“按名存取”，但查找速度慢、文件不允许重名、不便于文件共享

#### 两级目录结构

分为主文件目录和用户文件目录

提高了检索速度，解决了多用户文件重名问题；缺乏灵活性，不能对文件分类

#### 树形目录结构

便于分类，但不便于共享

#### 无环图目录结构

### 目录的操作

### 目录实现

#### 线性列表

#### 哈希表

### 文件共享

#### 基于索引结点的共享方式（硬链接）

索引结点新增count计数

==共享同一个内存索引结点==

有其他人引用，创建者也无法删除

#### 利用符号连接实现文件共享（软链接）

符号链接

只有文件主才拥有指向索引结点的指针

硬链接比软链接查找速度快

## 文件系统

### 文件系统结构

> 提供高效和便捷的磁盘访问，以便允许存储、定位、提取数据

实现对文件的按名存取

- 定义文件系统的用户接口
- 创建算法和数据结构，以便映射逻辑文件系统到物理外存设备

1. I/O 控制：包括设备驱动程序和中断处理程序，在内存和磁盘之间传输信息
2. 基本文件系统：向对应设备驱动程序发送通用命令，以读取和写入磁盘的物理块
3. 文件组织模块：组织文件及其逻辑块和物理块。将逻辑块地址转换成物理块地址
4. 逻辑文件系统：管理元数据信息

### 文件系统布局

#### 文件系统在磁盘中的结构

1. 主引导记录（Master Boot Record，MBR）：给出每个分区的起始和结束地址。确定活动分区
2. 引导块（boot block）：启动该分区中的操作系统
3. 超级块（super block）：包含文件系统所有关键信息，读入内存。包含文件的索引结构
4. 文件系统中空闲块信息

#### 文件系统在内存中的结构

1. 内存中的**安装表**（mount table）
2. 内存中的目录结构的缓存包含最近访问目录的信息
3. 整个系统的打开文件表
4. 每个进程的打开文件表

一旦文件被打开，内核就不再使用文件名来访问文件，而是使用文件描述符（Windows称之为文件句柄）

### 外存空闲空间管理

#### 空闲表法

连续分配方式

#### 空闲链表法

1. 空闲盘块链
2. 空闲盘区链

#### 位示图法

#### 成组链接法

结合空闲表和空闲链表两种方法

用来存放一组空闲盘块号的盘块称为**成组链块**

### 虚拟文件系统（VFS）

为用户程序提供文件系统操作的统一接口

并不是一种实际的文件系统，只存在于内存中，不存在任何外存空间

采用了面向对象的思想

- 超级块对象
- 索引结点对象
- 目录项对象
- 文件对象

### 分区和安装