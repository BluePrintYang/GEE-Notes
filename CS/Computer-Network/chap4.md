# 4. 网络层

## 网络层的功能

简单灵活的、无连接的、尽最大努力交付的数据报服务

### 异构网络互连

### 路由与转发

- 路由选择：
- 分组转发：

### SDN的基本概念

- 北向接口：编程接口
- 南向接口：转发设备建立双向会话
- 东西向接口：SDN 控制器集群内部控制器之间的通信接口

- 优点
  1. 全局集中式控制和分布式高速转发
  2. 灵活可编程与性能的平衡
  3. 降低成本
- 问题：
  1. 安全风险，易受攻击，崩溃则整个网络受影响
  2. 瓶颈问题，随着网络规模扩大，控制器可能成为网络性能瓶颈

### 拥塞控制

拥塞：因出现过量的分组而引起网络性能下降的现象

- 开环控制：静态的预防方法
- 闭环控制：基于反馈环路的概念，动态的方法

## 路由算法

### 静态路由与动态路由

静态路由算法（非自适应路由算法）：网络管理员手工配置的路由信息

动态路由算法（自适应路由算法）：路由表项通过路由器彼此交换信息，按照一定算法优化出来的

### 距离-向量路由算法

定期将它们的整个路由传送给所有与之直接相邻的结点

所有节点必须参与距离向量交换

RIP

### 链路状态路由算法

特征：

1. 向本自治系统的所有路由器发送信息，洪灾法
2. 发送的信息是与路由器相邻的所有路由器的链路状态
3. 只有发生变化才发送信息

OSPF

比较

- 距离-向量：只与邻居交谈，发送所有信息。可能遇到环路。
- 链路状态：与所有交谈，只发送邻居信息

### 层次路由

- 内部网关协议（IGP）（域内路由选择），例如 RIP，OSPF
- 外部网关协议（EGP）（域间路由选择），例如 BGP

## IPv4

### IPv4分组

数据传送的基本单元：IP 分组及其确切的数据格式

#### IPv4分组的格式

> 首部和数据部分构成。

首部：长度固定，20B，所有 IP 分组必须具有

首部包含：

1. 版本：4位
2. 首部长度：占4位，==以32位为单位==，最大值为60B（15x4B）。最常用为20B，不使用任何可选字段
3. 总长度：占16位。首部与数据部分之和，==单位为字节==，最大为$2^{16}-1=65535B$。以太网帧的最大传输单元（MTU）为1500B
4. 标识：占16位。计数器，数据报长度超过 MTU 时，需要分片。同一个标识指同一个数据报片
5. 标志：3位。最低位为MF，MF=1标识后面还有分片（More Fragment）。中间一位为DF，DF=0时才允许分片（Don't Fragment）
6. 片偏移：13位，==单位为8B==。某片在原分组中的相对位置。每个分片的长度一定是8B的整数倍
7. 生存时间（TTL）：占8位。数据报在网络中可通过的最大路由器数的最大值，确保分组不会永远在网络中循环。转发前先把TTL减1，TTL减为0，则必须丢弃
8. 协议：8位。6为TCP，17为UDP
9. 首部校验和：16位。只校验首部，不校验数据
10. 源地址字段：4B，IP地址
11. 目的地址字段：4B，IP地址

#### IP数据报分片

### IPv4地址与NAT

#### IPv4地址

32比特，由网络号和主机号构成

特殊IP，不用作主机的IP地址：

- 主机号全0表示网络本身
- 主机号全1表示本网络广播地址
- 127.x.x.x 保留为环回自检（Loopback ）地址，表示任意主机自身，不会出现在任何网络上
- 0.0.0.0 本网络上的本主机
- 255.255.255.255 整个 TCP/IP 网络的广播地址，**受限广播地址**。实际由于路由器对广播域的隔离，等效为本网络的广播地址

#### 网络地址转换（NAT）

将专用网络地址转换为公用地址，从而对外部隐藏内部管理的IP地址。节省了IP地址的消耗，降低了内部网络受到攻击的风险

私有IP地址网段：

- A类：1个网段，**10.**0.0.0～**10.**255.255.255
- B类：16个网段，**172.16.**0.0～**172.31.**255.255
- C类：256个网段，**192.168.0**.0～**192.168.255.**255

路由器对目的地址是私有地址的数据报一律不进行转发。

采用私有IP地址的互联网称为**专用互联网**或**本地互联网**

私有IP地址也称可重用地址

### 子网划分与子网掩码、CIDR

#### 子网划分

#### 子网掩码

#### 无分类编址CIDR

#### 网络层转发分组的过程

### ARP、DHCP与ICMP

#### IP地址与硬件地址

#### 地址解析协议（ARP）

ARP（Address Resolution Protrocol）：IP 地址到 MAC 地址的映射

工作在网络层

每台主机设有一个 ARP 高速缓存，用来存放本局域网上各主机和路由器的 IP 地址到 MAC 地址的映射表，称为 ARP 表，使用 ARP 动态维护此表

#### 动态主机配置协议（DHCP）

> Dynamic Host Configuration Protocol，给主机动态地分配 IP 地址

应用层协议，基于 UDP

由于没有 IP 地址，通过广播方式进行交互

#### 网际控制报文协议（ICMP）

> Internet Control Message Protocol，让主机或路由器报告差错和异常情况

网络层协议

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去

- ICMP 差错报文
  1. 终点不可达：
  2. 源点抑制：拥塞而丢弃，让源点把发送速率放慢
  3. 时间超过：TTL为零 ==Traceroute（Tracert）工作在网络层==
  4. 参数问题：首部有字段错误
  5. 改变路由（重定向）：改变路由报文，让主机下次发送给另外的路由器
- ICMP 询问报文：
  - 回送请求和回答报文 ==PING（工作在应用层）==
  - 时间戳请求和回答报文
  - 地址掩码请求和回答报文
  - 路由询问请求和通告报文

不发送差错报文的情况：

1. 对 ICMP 差错报文不再发送
2. 对第一个分片的数据报片的所有后续数据报片
3. 组播地址的数据报
4. 特殊地址（127.0.0.0或0.0.0.0）的数据报

## IPv6

### IPv6的主要特点

- 128 位 16B
- 首部为 8B 的整数倍
- 首部长度不可变
- 没有校验和字段
- 不可分片

### IPv6地址

目的地址

1. 单播
2. 多播
3. 任播：目的站是一组计算机，但交付时只交付给其中一台，通常是最近的一台

每四位用一个十六进制数表示，用冒号分割

- :0000: 可表示为 :0:
- 连续的 :0:0:0:  可表示为 :: 双冒号只能出现一次

IPv4 到 IPv6 过渡

- 双协议栈：一台设备同时装有 IPv4 和 IPv6 协议栈
- 隧道技术：把 IPv6 数据报封装到 IPv4 数据报的数据部分

## 路由协议

### 自治系统

### 域内路由与域间路由

#### 内部网关协议（Interior Gateway Protocol，IGP）

RIP 和 OSPF

#### 外部网关协议（External Gateway Protocol，EGP）

BGP-4

### 路由信息协议（RIP）

> 分布式的基于距离向量的路由选择协议，简单。
>
> 应用层协议，使用 ==UDP== 传送数据
>
> 不一定时间最短，但一定路由器最少

#### RIP规定

1. 维护自身到其他每个目的网络的距离
2. 距离也称跳数
3. 优先选择跳数最少
4. 最多15个路由器，16表示不可达
5. 任意两个 RIP 路由器之间每30秒广播一次路由更新信息
6. 不支持子网掩码的 RIP 广播

#### RIP的特点

1. 仅和相邻路由器交换信息
2. 交换全部信息
3. 固定时间间隔交换

RIP 最终是收敛的，收敛后，每个路由器到目的网络距离都是最短的

#### 距离向量算法

优点：简单，开销小，收敛快

缺点：

1. 限制了网络规模，最大跳数15
2. 交换完整信息，网络规模越大，开销越大
3. 出现故障时，会出现慢收敛现象。“坏消息传得慢”

### 开放最短路径优先（OSPF）协议

> 分布式链路状态路由算法
>
> 网络层协议，直接用 ==IP== 数据报传送

#### OSPF协议的基本特点

1. 向所有路由器发送信息，洪灾法
2. 信息是相邻路由器链路状态
3. 只有发生变化时，才发送信息
4. 网络层协议

其他特点：

1. 对于不同业务可计算不同路由
2. 同一网络有多条相同代价路径，可负载均衡
3. 仅在可信赖的路由器之间交换链路状态信息
4. 支持可变长的子网划分和无分类编制 CIDR
5. 每条链路都带有 32 位的序号，序号越大，状态越新

#### OSPF的基本工作原理

不存储完整路径，只存储下一跳

对于规模很大的网络，可再划分区域

#### OSPF的五种分组类型

1. 问候分组
2. 数据库描述分组
3. 链路状态请求分组
4. 链路状态更新分组
5. 链路状态确认分组

### 边界网关协议（BGP）

> 不同自治系统间路由器交换信息协议，常用于互联网的网关之间
>
> 应用层协议，基于 ==TCP==

只求寻找一条能够到达的较好的路由，并非寻找最佳。

每个自治系统至少选择一个（可以多个）路由器作为“发言人”

![路由协议比较](https://raw.githubusercontent.com/BluePrintYang/PicHub/master/premaster/image-20231007182939410.png)

## IP组播

### 组播的概念

让源计算机一次发送的单个分组可以抵达用一个组地址标识的若干目标主机

仅应用于 UDP

一台主机可同时属于多个组

使用 IGMP（因特网组管理协议）协议加入组播组

主机组播时仅发送一份数据，只有在数据传送路径上出现分岔时，才将分组复制后继续转发。组播需要路由器的支持才能实现。

### IP组播地址

使用 D 类地址，前四位为 1110， 范围是 224.0.0.0～239.255.255.255

1. 组播数据“尽最大努力交付”，不提供可靠交付
2. 组播地址只能用于目的地址，不能用于源地址
3. 不产生 ICMP 报文
4. 并非所有 D 类地址都可作为组播地址

分类：

1. 本局域网进行硬件组播
2. 因特网进行组播

IANA 拥有的以太网组播地址范围是 01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF ，只有23位可用于组播

组播 IP 与以太网硬件地址映射关系不是唯一的，收到组播数据报的主机，还要在 IP 层利用软件进行过滤，把不是本机要接收的数据报丢弃

### IGMP与组播路由算法

> Internet Group Management Protocol，使路由器知道组播组成员的信息

并不是因特网范围内对所有组播组成员进行管理的协议。IGMP 不知道 IP 组播组包含的成员数，也不知道这些成员分布在哪些网络上。IGMP 让连接到本地局域网上的组播路由器知道本局域网上是否有主机参加或退出了某个组播组

## 移动IP

### 移动IP的概念

移动站以固定的 IP地址实现跨越不同网段的漫游功能，并保证基于==网络 IP== 的网络权限==在漫游过程中不发生任何改变==

目标：把分组自动地投递给移动站

移动站：是把其连接点从一个网络或子网改变到另一个网络或子网的主机

三种功能实体：

1. 移动节点：具有永久 IP 的移动站
2. 本地代理：连接在归属网络上的路由器
3. 外地代理：连接在被访网络上的路由器

### 移动IP通信过程

- 永久地址：移动站原始地址
- 归属网络：移动站原始连接的网络。与永久地址关联是不变的
- 归属代理：连接到归属网络上的路由器
- 被访网络：移动站移动到另一地点所接入的网络
- 外地代理：被访网络使用的代理，通常是被访网络上的路由器

## 网络层设备

### 冲突域和广播域

#### 冲突域

#### 广播域

### 路由器的组成和功能

> 实现了网络模型的下三层：物理层、数据链路层和网络层

隔离广播域

- 直接交付：同一网络，无需经过路由器
- 间接交付

组成：

- 路由选择部分（控制部分）：核心构建是路由选择处理机
- 分组转发部分：
  - 交换结构：对分组进行处理
  - 一组输入端口：从比特流提取数据链路层帧，从帧提取数据报
  - 一组输出端口：相反操作

### 路由表与路由转发